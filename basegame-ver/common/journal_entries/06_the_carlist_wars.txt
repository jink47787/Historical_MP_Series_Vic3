je_the_first_carlist_war = {
	group = je_group_global_international_situations
	icon = "gfx/interface/icons/event_icons/event_carlist_beret.dds"

    is_shown_in_lobby = {
        OR = {
        	c:SPA ?= this
        	c:SPC ?= this
        }
    }

	modifiers_while_active = {
		carlist_war_guerilla_warfare
	}

	scripted_progress_bar = je_the_first_carlist_war_score_bar
	scripted_button = je_the_first_carlist_war_royal_expedition_button
	scripted_button = je_the_first_carlist_flush_them_out_button

	should_be_involved = {
		country_has_primary_culture = cu:spanish
		is_in_geographic_region = geographic_region_iberia
	}

	should_show_when_not_involved = {
		always = no
	}

	immediate = {
		if = {
			limit = {
				NOT = { has_global_variable = spa_carlist_war_score }
			}
			set_global_variable = {
				name = spa_carlist_war_score
				value = 0
			}
		}
		if = {
			limit = {
				NOT = { has_global_variable = spc_carlist_war_score }
			}
			set_global_variable = {
				name = spc_carlist_war_score
				value = 0
			}
		}
		if = {
			limit = {
				NOT = { has_global_variable = carlist_war_skirmish_phase }
			}
			set_global_variable = carlist_war_skirmish_phase
		}
	}

	immediate_all_involved = {
		set_variable = coup_immunity
	}

	status_desc = {
		first_valid = {
			triggered_desc = {
				desc = je_the_first_carlist_war_status
				trigger = {
					has_global_variable = carlist_war_skirmish_phase
				}
			}
			triggered_desc = {
				desc = je_the_first_carlist_war_status_royal_expedition
				trigger = {
					always = yes
				}
			}
		}
	}

	on_monthly_pulse = {
		effect = {
			c:SPC ?= {
				random_list = {
					9 = {}
					1 = { trigger_event = carlist_war.5 }
					1 = { trigger_event = carlist_war.6 }
				}
			}
		}
	}

	complete = {
		custom_tooltip = {
			text = je_the_first_carlist_war_complete
			NAND = {
				exists = c:SPC
				exists = c:SPA
			}
		}
	}

	on_complete_all_involved = {
		if = {
			limit = {
				c:SPC ?= this
			}
			change_tag = SPA
			set_capital = STATE_NEW_CASTILE
			set_variable = spain_carlist_victory
			add_modifier = {
				name = carlist_war_spc_reward
				years = 20
				is_decaying = yes
			}
			hidden_effect = {
				every_scope_state = {
					limit = {
						state_region = {
							is_homeland = cu:spanish
						}
					}
					set_state_type = incorporated
				}
			}
			set_variable = is_carlist_spain
		}
		else_if = {
			limit = {
				c:SPA ?= this
			}
			add_modifier = {
				name = carlist_war_spa_reward
				years = 20
				is_decaying = yes
			}
		}
		trigger_event = carlist_war.2
		hidden_effect = {
			remove_global_variable = spa_carlist_war_score
			remove_global_variable = spc_carlist_war_score
			remove_modifier = national_guard_preoccupied
			remove_modifier = the_last_stand
			remove_modifier = galvanized_forces
			remove_modifier = spc_secure_port
			remove_modifier = spa_carlist_terror_expenses
			remove_modifier = captured_royal_arsenals
			set_immune_to_revolutions = no
			remove_variable = coup_immunity

			if = {
				limit = {
					any_scope_state = {
						has_modifier = spa_carlist_terror
					}
				}
				every_scope_state = {
					limit = {
						has_modifier = spa_carlist_terror
					}
					remove_modifier = spa_carlist_terror
				}
			}
			if = {
				limit = {
					any_scope_State = {
						has_modifier = ad_hoc_manufacturing
					}
				}
				every_scope_state = {
					limit = {
						has_modifier = ad_hoc_manufacturing
					}
					remove_modifier = ad_hoc_manufacturing
				}
			}
			if = {
				limit = {
					any_scope_state = {
						has_modifier = spc_raided_grain_storages
					}
				}
				every_scope_state = {
					limit = {
						has_modifier = spc_raided_grain_storages
					}
					remove_modifier = spc_raided_grain_storages
				}
			}
			if = {
				limit = {
					any_scope_state = {
						has_modifier = pyrenean_smuggling
					}
				}
				every_scope_state = {
					limit = {
						has_modifier = pyrenean_smuggling
					}
					remove_modifier = pyrenean_smuggling
				}
			}
			if = {
				limit = {
					any_scope_state = {
						has_modifier = ad_hoc_manufacturing_negative
					}
				}
				every_scope_state = {
					limit = {
						has_modifier = ad_hoc_manufacturing_negative
					}
					remove_modifier = ad_hoc_manufacturing_negative
				}
			}
		}
	}

	weight = 10000

	should_be_pinned_by_default = yes
}

