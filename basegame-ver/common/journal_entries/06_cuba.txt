je_cuba_la_vida_dulce = { # cuba stays with Spain
    icon = "gfx/interface/icons/event_icons/event_trade.dds"

    group = je_group_historical_content

    is_shown_in_lobby = {
        c:CUB ?= THIS
    }

    status_desc = {
        desc = je_cuba_la_vida_dulce_trade_tracker
    }

    possible = {
        # triggered by history
    }

    immediate = { 
        ig:ig_landowners ?= {
            save_scope_as = landowners_ig
        }
        root.overlord = {
            save_scope_as = boss
        }
    }

    complete = {
        custom_tooltip = {
            text = CUB_total_country_exports_greater_than_tt
            total_country_exports > je_cuba_la_vida_dulce_export_target
        }
    }

    on_complete = {
        add_modifier = {
            name = cuba_dominate_market
        }  
        trigger_event = {
            id = cuba_events.1
            popup = yes
        }
        if = {
            limit = {
                has_law_or_variant = law_type:law_slavery_banned
            }
            add_modifier = {
                name = cuba_success_without_slavery
                days = even_longer_modifier_time #if changing this, also change slavery_abolished_for_more_tt
                is_decaying = yes
            }
        }
        else = { #Show the player what they are missing
            custom_tooltip = slavery_abolished_for_more_tt
        }
    }

     event_outcome_completed_effect_desc = {
        header = cuba_events.1.a
        effect = {
            if = {
                limit = {
                    has_law_or_variant = law_type:law_slave_trade
                }
                add_modifier = {
                    name = slavery_continues
                    days = even_longer_modifier_time
                    is_decaying = yes
                }
                random_political_movement = {
                    limit = {
                        is_political_movement_type = movement_slave_revolt
                    }
                    add_modifier = {
                        name = slave_revolt_risk
                    }
                }
            }
        }
    }

    event_outcome_completed_effect_desc = {
        header = cuba_events.1.c
        effect = {
            ROOT = {
                add_culture_acceptance_modifier = {
                    culture = cu:afro_caribeno
                    multiplier = 20
                }
            }
            add_modifier = {
                name = cuba_share_success
                days = even_longer_modifier_time
                is_decaying = yes
            }
            if = {
                limit = {
                    NOT = {
                        has_law_or_variant = law_type:law_right_to_associate
                    }
                }
                activate_law = law_type:law_right_to_associate
            }
        }
    }

    event_outcome_completed_effect_desc = {
        header = cuba_events.1.b
        effect = {
            add_modifier = {
                name = cuba_success_modernise
                days = even_longer_modifier_time
                is_decaying = yes
            }
        }
    }

    event_outcome_completed_effect_desc = {
        header = cuba_events.1.fix
        effect = {
            add_modifier = {
                name = cuba_libre_from_trade
                days = stupidly_long_modifier_time
            }
        }
    }

    fail = {
    }

    invalid = {
    }

    weight = 100
    should_be_pinned_by_default = yes
}

je_cuba_espanol = { # cuba stays with Spain
    icon = "gfx/interface/icons/event_icons/event_default.dds"

    group = je_group_historical_content

    is_shown_in_lobby = {
        c:CUB ?= THIS
    }

    status_desc = {
        desc = je_cuba_espanol_tracker
    }

    on_monthly_pulse = {
    }

    possible = {
        # triggered by history
    }

    immediate = {
        ig:ig_landowners ?= {
            save_scope_as = landholders
        }
        cu:caribeno = {
            save_scope_as = caribeno
        }
        cu:spanish = {
            save_scope_as = spanish
        }
    }

    custom_completion_header = je_cuba_espanol_completion_header

    complete = {
        hidden_trigger = { #AI doesn't do this.
            is_player = yes
        }
        liberty_desire_weekly_progress < 0
        liberty_desire < 10
        custom_tooltip = {
            text = CUB_espana_total_country_exports_greater_than_tt
            total_country_exports > je_cuba_es_espana_export_target
        }
        trigger_if = {
            limit = {
                has_dlc_feature = foreign_investment
            }
            custom_tooltip = {
                text = has_investment_rights_with_overlord
                has_diplomatic_pact = {
                    type = da_overlord_grant_investment_rights
                    who = root.overlord
                }
            }
            overlord ?= {
                gdp_ownership_ratio = {
                    target = ROOT
                    value >= 0.05
                }
            }
        }
        trigger_else = { #If they don't own Sphere of Influence
            country_has_building_group_levels = {
                type = bg_plantations
                value  >= 50
            }
        }
    }
    
    custom_on_completion_header = je_cuba_espanol_completion_header_victory_header

    on_complete = {
        overlord = {
            add_primary_culture = cu:caribeno
        }
        trigger_event = {
            id = cuba_events.2
            popup = yes
        }
        custom_tooltip = join_with_spain_choice_tt
        custom_tooltip = join_with_spain_no_independence_tt
    }

    invalid = { #If someone else becomes overlord outside of Iberia, then JE dies
        NOT = {
            overlord = {
                capital = {
                    region = sr:region_iberia
                }
            }
        }
    }

    fail = {
        OR = {
            ig:ig_landowners ?= {
                is_powerful = no
            }
            AND = {
                liberty_desire_weekly_progress > 0
                liberty_desire >= 75
            }
            is_subject = no
        }
    }

    on_fail = {
        add_modifier = {
            name = reformists_dispand
            days = long_modifier_time
        }
        trigger_event = {
            id = cuba_events.3
            popup = yes
        }
    }


    event_outcome_completed_effect_desc = {
        header = cuba_events.2.a
        effect = {
            cuba_annex_effects = yes
        }
    }

    event_outcome_completed_effect_desc = {
        header = cuba_events.2.e
        effect = {
            add_modifier = {
                name = cuba_libre_from_trade
                days = normal_modifier_time
            }
        }
    }

    event_outcome_completed_effect_desc = {
        header = cuba_events.2.c
        effect = {
            custom_tooltip = cuba_if_spa_player_tt
        }
    }

    event_outcome_failed_effect_desc = {
        header = cuba_events.3.a
        effect = {
            add_modifier = {
                name = reformists_gone_pro_cuba
                days = long_modifier_time
                is_decaying = yes
            }
            add_liberty_desire = 10
        }
    }

    event_outcome_failed_effect_desc = {
        header = cuba_events.3.b
        effect = {
            add_modifier = {
                name = cuba_dont_hurt_business
                days = long_modifier_time
            }
        }
    }

    event_outcome_failed_effect_desc = {
        header = cuba_events.3.c.fix
        effect = {
            random_political_movement = {
                limit = {
                    is_political_movement_type = movement_slave_revolt
                }
                add_modifier = {
                    name = slave_revolt_risk
                    multiplier = 4
                    days = normal_modifier_time
                }
            }
        }
    }

    should_be_pinned_by_default = yes
    weight = 5000
}

je_cuba_independencia = { # viva cuba
	icon = "gfx/interface/icons/event_icons/waving_flag.dds"

	group = je_group_historical_content

    is_shown_in_lobby = {
        c:CUB ?= THIS
    }

	possible = {
        #triggered by history
	}

    status_desc = {
        desc = je_cuba_custom_status_desc
    }

    scripted_progress_bar = je_cuba_total_bar

    scripted_button = je_cuba_promise_freedom 
    scripted_button = je_cuba_ask_usa_to_buy
    scripted_button = je_cuba_independence_war

	immediate = { #Maybe these are done by the bars themselves?
        set_variable = { 
            name = independencia_current
            value = 35
        }
        set_variable = { 
            name = independencia_target 
            value = je_cuba_independencia_bar_target 
        }
        ig:ig_landowners ?= {
            save_scope_as = landowners_ig
        }
        c:SPA ?= {
            save_scope_as = spain
        }
        c:USA ?= {
            save_scope_as = usa
        }
        c:HAI ?= {
            save_scope_as = haiti
        }
        s:STATE_FLORIDA = {
            save_scope_as = florida_region
        }
	}

	on_weekly_pulse = {
        effect = {
            set_variable = { 
                name = independencia_current
                value = "scope:journal_entry.scripted_bar_progress(je_cuba_total_bar)" 
            }
            set_variable = { 
                name = independencia_target 
                value = je_cuba_independencia_bar_target
            }
        }
    }

    on_monthly_pulse = {
        effect = {
            if = {
                limit = {
                    NOT = { exists = scope:csa}
                    exists = c:CSA
                }
                c:CSA ?= {
                    save_scope_as = csa
                }
            }
        }
	}

	custom_completion_header = je_cuba_independencia_completion_header

	complete = {
        OR = {
            trigger_if = {
                limit = {
                    exists = c:CSA
                    s:STATE_FLORIDA = {
                        any_scope_state = {
                            owner = c:CSA
                        }
                    }
                }
                custom_tooltip = {
                    text = je_cuba_has_joined_csa
                    c:USA ?= {
                        is_country_alive = no
                    }
                    c:CUB ?= {
                        is_country_alive = no
                    }
                }
            }
            trigger_else = {
                custom_tooltip = {
                    text = je_cuba_has_joined_usa
                    c:USA ?= {
                        is_country_alive = no
                    }
                    c:CUB ?= {
                        is_country_alive = no
                    }
                }
            }
            custom_tooltip = {
                text = je_cuba_has_gained_independence
                c:CUB ?= {
                    is_subject = no
                }
            }
            custom_tooltip = { #slave revolt case
                text = je_cuba_has_gained_revolted
                NOR = {
                    c:CUB ?= this
                    was_formed_from = CUB
                }
                root = {
                    country_has_primary_culture = cu:afro_caribeno
                }
            }
        }
	}
    
	custom_on_completion_header = cuba_free_header

	on_complete = {
		if = {
            limit = {
                has_variable = slaves_work_with_independence_movement
                NOT = {
                    has_law_or_variant = law_type:law_slavery_banned
                }
            }
            activate_law = law_type:law_slavery_banned
        }
        if = {
            limit = {
                has_variable = slaves_work_with_independence_movement
            }
            add_primary_culture = cu:afro_caribeno
        }
        add_modifier = {
            name = cuba_libre_chill
            days = long_modifier_time
        }
        add_modifier = {
            name = cuba_libre_total
        }
        add_modifier = {
            name = cuba_libre_market
            days = even_longer_modifier_time
            is_decaying = yes
        }
        add_loyalists = {
            value = large_radicals
            strata = middle
        }
        add_loyalists = {
            value = medium_radicals
            strata = lower
        }
	}

	weight = 20

    should_be_pinned_by_default = yes
    transferable = yes
}


